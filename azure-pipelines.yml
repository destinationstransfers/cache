# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

jobs:
  - job: Linux
    pool:
     vmImage: 'Ubuntu-16.04'
    steps:
      - template: azure-pipelines-steps.yml

  - job: Windows
    pool:
      vmImage: vs2017-win2016
    steps:
      - script: |
          git config --global core.autocrlf false
          git config --global core.symlinks true
        displayName: 'Preserve LF endings and symbolic links on check out'
      - task: NodeTool@0
        inputs:
          versionSpec: '11.x'
        displayName: 'Install Node.js'
      - script: npm install --no-package-lock --no-optional
        # skip weak
        displayName: 'npm install'
      - script: node --expose-gc node_modules/jest/bin/jest --runInBand --logHeapUsage --ci --reporters=default
        displayName: 'Run Jest'
      - script: 'npx codecov'
        condition: succeededOrFailed()
        displayName: 'Upload to Codecov'

  - job: macOS
    pool:
      vmImage: macos-10.13
    steps:
      # This step can be removed once Mercurial gets installed on the macOS image. See https://github.com/Microsoft/azure-pipelines-image-generation/issues/604
      - script: HOMEBREW_NO_AUTO_UPDATE=1 brew install mercurial
        displayName: 'Install Mercurial'
      - template: azure-pipelines-steps.yml

variables:
  # Used by chalk. Ensures output from Jest includes ANSI escape characters that are needed to match test snapshots.
  FORCE_COLOR: 1

  # Ensures the handful of tests that should be skipped during CI are
  CI: true
